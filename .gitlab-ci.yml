# GitLab CI/CD Pipeline for Document Classifier
# Stages: build → test → deploy

image: docker:19

variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  REGISTRY: "192.168.49.2:5000"
  IMAGE_NAME: "document-classifier"

stages:
  - build
  - test
  - deploy

# Build and push Docker image
build_image:
  stage: build
  script:
    - echo "Building Docker image..."
    - docker build -t $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    - docker tag $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA $REGISTRY/$IMAGE_NAME:latest
    - echo "Pushing to registry..."
    - docker push $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $REGISTRY/$IMAGE_NAME:latest
    - echo "Build complete!"

# Test the image
test_image:
  stage: test
  script:
    - echo "Pulling image for testing..."
    - docker pull $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - echo "Testing imports..."
    - docker run --rm $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA python -c "from src.classifier import DocumentClassifier; print('✅ Classifier OK')"
    - docker run --rm $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA python -c "from src.trainer import ModelTrainer; print('✅ Trainer OK')"
    - docker run --rm $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA python -c "from src.normalizer import TextNormalizer; print('✅ Normalizer OK')"
    - docker run --rm $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA python -c "from src.ocr import OCRExtractor; print('✅ OCR OK')"
    - docker run --rm $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA python -c "from monitoring import MonitoringService; print('✅ Monitoring OK')"
    - docker run --rm $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA python -c "from api import app; print('✅ API OK')"
    - echo "All tests passed!"

# Deploy notification
deploy_to_argo:
  stage: deploy
  script:
    - echo "=========================================="
    - echo "Image ready for deployment!"
    - echo "Registry -> $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - echo "Latest   -> $REGISTRY/$IMAGE_NAME:latest"
    - echo "=========================================="
    - echo "To deploy on Argo, run:"
    - echo "  argo submit -n argo ml-workflow.yaml --watch"
    - echo "=========================================="
  only:
    - main
